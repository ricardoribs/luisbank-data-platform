name: LuisBank CI Pipeline

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    env:
      MINIO_ROOT_USER: ${{ secrets.MINIO_ROOT_USER || 'minioadmin' }}
      MINIO_ROOT_PASSWORD: ${{ secrets.MINIO_ROOT_PASSWORD || 'minioadmin123' }}
      MINIO_ENDPOINT: http://localhost:9000
      MINIO_S3_ENDPOINT: localhost:9000
      MINIO_BUCKET: landing-zone
      SAFETY_API_KEY: ${{ secrets.SAFETY_API_KEY }}

    steps:
    - name: Checkout codigo
      uses: actions/checkout@v3

    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.10"

    - name: Instalar Dependencias
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install dbt-duckdb

    - name: Start MinIO (local)
      run: |
        docker run -d --name minio \
          -p 9000:9000 -p 9001:9001 \
          -e MINIO_ROOT_USER=${MINIO_ROOT_USER} \
          -e MINIO_ROOT_PASSWORD=${MINIO_ROOT_PASSWORD} \
          minio/minio server /data --console-address ":9001"
        sleep 5

    - name: Seed Data (Generators)
      run: |
        python -m src.generators.master_data
        python -m src.generators.transaction_generator

    - name: Security Scan
      run: |
        pip install safety bandit
        if [ -z "$SAFETY_API_KEY" ]; then
          echo "SAFETY_API_KEY not set; skipping safety scan."
        else
          safety scan --key "$SAFETY_API_KEY"
        fi
        bandit -r src/ -c .bandit

    - name: Linting (Qualidade de Codigo)
      run: |
        pip install flake8
        flake8 src --count --select=E9,F63,F7,F82 --show-source --statistics
        flake8 src --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

    - name: Testes (Pytest)
      run: |
        pytest -q

    - name: Setup dbt
      run: |
        cd dbt_project
        dbt deps --profiles-dir .

    - name: dbt Run (staging only)
      run: |
        cd dbt_project
        dbt run --profiles-dir . --select stg_accounts stg_customers stg_transactions

    - name: dbt Snapshot
      run: |
        cd dbt_project
        dbt snapshot --profiles-dir .

    - name: dbt Run (marts)
      run: |
        cd dbt_project
        dbt run --profiles-dir . --select dim_accounts dim_customers fct_transactions dm_rfm_segmentation

    - name: Validar SQL do dbt (Compile)
      run: |
        cd dbt_project
        dbt compile --profiles-dir .

    - name: dbt Test Coverage
      run: |
        cd dbt_project
        dbt test --profiles-dir . --fail-fast
